<!doctype html>
<html lang="en">
  <head>
    <title>BlackBear | Journal</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link rel="stylesheet" href="css/vendor/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <style>
      /* Estética BlackBear */
      body { background-color: #000; color: #fff; font-family: 'Poppins', sans-serif; }
      .unslate_co--site-inner { background-color: transparent; }
      
      /* Header del Post */
      .cover-v1.overlay { position: relative; background-size: cover; background-position: center; }
      .cover-v1.overlay:before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); }
      
      /* Contenido del Post */
      .post-content { color: #ccc; font-size: 1.1rem; line-height: 1.8; }
      .post-content img { width: 100%; border-radius: 10px; margin: 35px 0; border: 1px solid #333; }
      
      /* Navegación Circular */
      .navigation-post p { color: #fff; font-weight: 700; font-size: 1.2rem; margin-top: 5px; transition: 0.3s; }
      .navigation-post span { color: #ef3159; text-transform: uppercase; font-size: 12px; letter-spacing: 2px; font-weight: 600; }
      .navigation-post a:hover p { color: #ef3159; }
      .navigation-post a { text-decoration: none !important; }
      
      /* Comentarios Lineales */
      .comment-v1 { border-bottom: 1px solid #222; padding: 30px 0; list-style: none; }
      .comment-v1 h3 { color: #ef3159; font-size: 18px; margin-bottom: 5px; font-weight: 700; }
      .comment-date { font-size: 12px; color: #555; margin-bottom: 15px; text-transform: uppercase; }
      .comment-list { padding: 0; }
      
      /* Formulario */
      .form-control { background: #111; border: 1px solid #222; color: #fff; padding: 15px; border-radius: 5px; }
      .form-control:focus { background: #151515; color: #fff; border-color: #ef3159; box-shadow: none; }
      label { color: #777; font-size: 14px; margin-bottom: 10px; }
      .btn-custom { background-color: #ef3159; color: white; padding: 12px 30px; border-radius: 50px; border: none; font-weight: 700; transition: 0.3s; }
      .btn-custom:hover { background-color: #c42648; transform: translateY(-2px); }
    </style>
  </head>
  <body>

    <div class="unslate_co--site-wrap">
      <div class="unslate_co--site-inner">

        <div class="cover-v1 jarallax overlay" id="post-header" style="height: 80vh;">
          <div class="container">
            <div class="row align-items-center justify-content-center" style="height: 80vh;">
              <div class="col-md-10 text-center" style="position: relative; z-index: 2;">
                <h1 class="blog-heading" id="post-title" style="font-size: 4rem; font-weight: 900;">Cargando...</h1>
                <div class="post-meta" id="post-meta" style="font-size: 1.2rem; color: #ef3159;"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="unslate_co--section">
          <div class="container">
            <div class="row justify-content-center">
              <div class="col-md-8 post-content" id="post-content"></div>
            </div>

            <div class="row mt-5 pt-5 navigation-post border-top border-dark">
              <div class="col-6">
                <a href="#" id="prev-link">
                  <span>&larr; Previous Post</span>
                  <p id="prev-title">...</p>
                </a>
              </div>
              <div class="col-6 text-right">
                <a href="#" id="next-link">
                  <span>Next Post &rarr;</span>
                  <p id="next-title">...</p>
                </a>
              </div>
            </div>

            <div class="row justify-content-center mt-5 pt-5">
              <div class="col-md-8">
                <h3 class="mb-5" id="comment-count" style="font-weight: 800; font-size: 2rem;">0 Comments</h3>
                <ul class="comment-list" id="dynamic-comments"></ul>

                <div class="comment-form-wrap pt-5">
                  <h3 class="mb-5" style="font-weight: 800;">Leave a comment</h3>
                  <form id="commentForm" class="p-5 bg-black border border-dark">
                    <div class="form-group mb-4">
                      <label for="name">Name *</label>
                      <input type="text" class="form-control" id="name" required placeholder="Your Name">
                    </div>
                    <div class="form-group mb-4">
                      <label for="message">Message *</label>
                      <textarea id="message" cols="30" rows="5" class="form-control" required placeholder="Write your thoughts..."></textarea>
                    </div>
                    <div class="form-group">
                      <input type="submit" value="Post Comment" class="btn-custom" id="submitBtn">
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
      // 1. CONFIGURACIÓN DE LINKS
      const URL_POSTS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSBApKJcrHq_sBa2EA4YDyj4GeFrGJ-uH6HzYjGaMbw_tQAIg1Ll6h_w42HbyC2Wuz5uVIDAG0nvbo0/pub?gid=0&single=true&output=csv";
      const URL_COMENTARIOS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSBApKJcrHq_sBa2EA4YDyj4GeFrGJ-uH6HzYjGaMbw_tQAIg1Ll6h_w42HbyC2Wuz5uVIDAG0nvbo0/pub?gid=328009394&single=true&output=csv";
      const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycby1w3WCAhLKvRlppqqnwf4TLyb8yCVcz6KXxnsO-gwsz_wJqb1Dj7a4vbQISltivviqzA/exec";

      const params = new URLSearchParams(window.location.search);
      const postID = parseInt(params.get('id')) || 1;

      // 2. CARGAR POST Y NAVEGACIÓN CIRCULAR
      Papa.parse(URL_POSTS, {
        download: true, header: true,
        complete: function(res) {
          const posts = res.data.filter(p => p.ID && p.ID.trim() !== "");
          const post = posts.find(p => p.ID == postID) || posts[0];

          document.getElementById('post-title').innerText = post.Titulo;
          document.getElementById('post-meta').innerText = `By ${post.Autor} • ${post.Fecha} • ${post.TiempoLectura}`;
          document.getElementById('post-content').innerHTML = post.Contenido;
          document.getElementById('post-header').style.backgroundImage = `url('${post.ImagenPortada}')`;

          // Lógica Circular de Navegación
          let idx = posts.findIndex(p => p.ID == postID);
          let prev = posts[(idx - 1 + posts.length) % posts.length];
          let next = posts[(idx + 1) % posts.length];

          document.getElementById('prev-link').href = `blog-single.html?id=${prev.ID}`;
          document.getElementById('prev-title').innerText = prev.Titulo;
          document.getElementById('next-link').href = `blog-single.html?id=${next.ID}`;
          document.getElementById('next-title').innerText = next.Titulo;
        }
      });

      // 3. CARGAR COMENTARIOS LINEALES
      Papa.parse(URL_COMENTARIOS, {
        download: true, header: true,
        complete: function(res) {
          const comments = res.data.filter(c => c.PostID == postID);
          document.getElementById('comment-count').innerText = `${comments.length} Comments`;
          let html = "";
          comments.reverse().forEach(c => { // Los más nuevos arriba
            html += `
              <li class="comment-v1">
                <h3>${c.Nombre}</h3>
                <div class="comment-date">${c.Fecha}</div>
                <p>${c.Mensaje}</p>
              </li>`;
          });
          document.getElementById('dynamic-comments').innerHTML = html;
        }
      });

      // 4. ENVIAR COMENTARIO AL EXCEL
      document.getElementById('commentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.value = "Sending...";
        btn.disabled = true;

        const formData = new URLSearchParams();
        formData.append('postID', postID);
        formData.append('name', document.getElementById('name').value);
        formData.append('message', document.getElementById('message').value);

        fetch(URL_APPS_SCRIPT, {
          method: 'POST',
          mode: 'no-cors',
          body: formData
        }).then(() => {
          alert("¡Éxito! Tu comentario aparecerá en breve.");
          location.reload();
        }).catch(() => {
          alert("Error al enviar. Intenta de nuevo.");
          btn.disabled = false;
          btn.value = "Post Comment";
        });
      });
    </script>
  </body>
</html>
